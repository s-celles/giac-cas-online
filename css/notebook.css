  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Newsreader:ital,opsz,wght@0,6..72,400;0,6..72,500;1,6..72,400&display=swap');

  :root {
    --bg:#f4f2ed;--surface:#fff;--border:#d9d4ca;--border-focus:#2563eb;
    --text:#1c1917;--text-muted:#78716c;--output-bg:#fafaf6;
    --accent:#2563eb;--accent-hover:#1d4ed8;--accent-light:#eff3ff;
    --success:#15803d;--error:#b91c1c;--warning:#ca8a04;
    --shadow-sm:0 1px 2px rgba(0,0,0,0.04);--shadow:0 2px 8px rgba(0,0,0,0.06);
    --radius:10px;
    --mono:'JetBrains Mono','Menlo','Consolas',monospace;
    --body:'Newsreader','Georgia',serif;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:var(--body);background:var(--bg);color:var(--text);line-height:1.65}

  /* ═══════ Header ═══════ */
  .header{background:#0c0f1a;color:#eae8e0;padding:1.6rem 2rem 1.2rem;position:relative;overflow:hidden}
  .header::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 500px 250px at 5% 90%,rgba(37,99,235,.12),transparent),radial-gradient(ellipse 350px 180px at 95% 10%,rgba(168,85,247,.08),transparent);pointer-events:none}
  .header-inner{position:relative;max-width:960px;margin:0 auto;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
  .header-left h1{font-family:var(--mono);font-size:1.35rem;font-weight:500;letter-spacing:-.3px}
  .header-left p{font-size:.82rem;opacity:.5;margin-top:.1rem;font-family:var(--mono)}
  .header-right{display:flex;align-items:center;gap:.75rem;margin-top:.2rem}
  #giac-status{display:inline-flex;align-items:center;gap:5px;font-family:var(--mono);font-size:.7rem;padding:4px 11px;border-radius:20px;background:rgba(255,255,255,.07);transition:background .3s}
  #giac-status .dot{width:7px;height:7px;border-radius:50%;background:#facc15;transition:background .3s}
  #giac-status.ready .dot{background:#4ade80}
  #giac-status.error .dot{background:#f87171}
  .lang-select{font-family:var(--mono);font-size:.7rem;padding:3px 8px;border-radius:5px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:#eae8e0;cursor:pointer;outline:none}
  .lang-select:hover{border-color:rgba(255,255,255,.3)}
  .lang-select option{background:#1c1917;color:#eae8e0}

  /* ═══════ Toolbar ═══════ */
  .toolbar-wrap{border-bottom:1px solid var(--border);background:var(--surface);padding:0 2rem}
  .toolbar{max-width:960px;margin:0 auto;display:flex;gap:.4rem;padding:.6rem 0;flex-wrap:wrap;align-items:center}
  .toolbar button{font-family:var(--mono);font-size:.72rem;padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text);cursor:pointer;transition:all .15s;white-space:nowrap}
  .toolbar button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  .toolbar button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .toolbar button.primary:hover{background:var(--accent-hover)}
  .toolbar .sep{width:1px;height:20px;background:var(--border);margin:0 .15rem}

  .examples-menu{position:absolute;top:100%;left:0;z-index:100;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 4px 12px rgba(0,0,0,.12);padding:.3rem;min-width:180px}
  .examples-menu button{display:block;width:100%;text-align:left;font-family:var(--mono);font-size:.75rem;padding:6px 10px;border:none;border-radius:4px;background:transparent;color:var(--text);cursor:pointer}
  .examples-menu button:hover{background:var(--accent);color:#fff}

  /* ═══════ About Dialog ═══════ */
  .about-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:1rem}
  .about-dialog{position:relative;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.18);padding:2rem 2.2rem;max-width:540px;width:100%;max-height:85vh;overflow-y:auto;font-family:var(--body);color:var(--text)}
  .about-dialog h2{font-family:var(--mono);font-size:1.2rem;font-weight:600;margin-bottom:.1rem}
  .about-dialog .about-version{font-family:var(--mono);font-size:.75rem;color:var(--text-muted);margin-bottom:.2rem}
  .about-dialog .about-author{font-size:.82rem;color:var(--text-muted);margin-bottom:.8rem}
  .about-dialog h3{font-family:var(--mono);font-size:.85rem;font-weight:500;margin-top:1.2rem;margin-bottom:.4rem;color:var(--accent)}
  .about-dialog p{font-size:.85rem;line-height:1.6;margin-bottom:.5rem}
  .about-dialog table{width:100%;border-collapse:collapse;font-size:.78rem;margin:.4rem 0 .8rem}
  .about-dialog th{text-align:left;font-family:var(--mono);font-weight:500;padding:5px 8px;border-bottom:2px solid var(--border);font-size:.72rem;color:var(--text-muted)}
  .about-dialog td{padding:5px 8px;border-bottom:1px solid var(--border)}
  .about-dialog a{color:var(--accent);text-decoration:none}
  .about-dialog a:hover{text-decoration:underline}
  .about-close{position:absolute;top:.7rem;right:.9rem;background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);line-height:1}
  .about-close:hover{color:var(--text)}
  .about-qr{text-align:center;margin-top:.8rem}
  .about-qr svg{width:160px;height:160px;display:inline-block}
  .about-qr-url{font-family:var(--mono);font-size:.7rem;color:var(--text-muted);word-break:break-all;margin-top:.3rem}

  /* ═══════ Slider cells ═══════ */
  .cell[data-type="slider"] .cell-badge{background:#8b5cf6;color:#fff}
  .slider-params{padding:.5rem 0}
  .slider-code{padding:.4rem .6rem;margin-top:.3rem;background:var(--output-bg);border:1px solid var(--border);border-radius:4px;font-family:var(--mono);font-size:.8rem;line-height:1.5;overflow-x:auto}
  .slider-code code{display:block;white-space:pre-wrap;word-break:break-all}
  .slider-expr-template{color:var(--text-muted);font-size:.75rem}
  .slider-expr-template::before{content:'Expression: ';font-weight:500}
  .slider-expr-resolved{color:var(--text);margin-top:.15rem}
  .slider-expr-resolved::before{content:'\2192  ';color:var(--accent);font-weight:500}
  .slider-fallback{color:var(--text-muted);font-size:.85rem;font-style:italic;padding:.5rem 0}
  .slider-static{font-size:.85rem;color:var(--text);padding:.15rem 0}
  .report-mode .slider-params slider-param{pointer-events:none;opacity:.6}
  .report-mode .slider-params slider-param input[type=range]{display:none}
  .report-mode .slider-code{display:none}
  @media(max-width:600px){
    .slider-params slider-param{--slider-label-width:90px}
  }

  /* ═══════ @bind sliders in text cells ═══════ */
  .md-out slider-param{display:block;margin:.4rem 0}
  .md-out .bind-fallback{font-size:.85rem;color:var(--text-muted);font-style:italic;padding:.3rem 0}
  .report-mode .md-out slider-param{pointer-events:none;opacity:.6}
  .report-mode .md-out slider-param input[type=range]{display:none}

  /* ═══════ Notebook ═══════ */
  .notebook{max-width:960px;margin:1.2rem auto;padding:0 1rem 5rem}

  /* ═══════ Empty Notebook ═══════ */
  .empty-notebook{text-align:center;padding:3rem 1rem;color:var(--text-muted);font-family:var(--mono)}
  .empty-notebook p{font-size:1rem;margin-bottom:1rem}
  .empty-notebook button{font-size:.9rem;padding:.5rem 1.2rem;border:1.5px dashed var(--border);border-radius:var(--radius);background:transparent;color:var(--accent);cursor:pointer;font-family:var(--mono);transition:all .15s}
  .empty-notebook button:hover{background:var(--accent-light);border-color:var(--accent)}
  .empty-notebook .empty-hint{font-size:.75rem;margin-top:1rem;opacity:.7}

  .notebook-footer{text-align:center;padding:1rem;color:var(--text-muted);font-family:var(--mono)}
  .notebook-footer .empty-hint{font-size:.75rem;opacity:.7}

  /* ═══════ Cell ═══════ */
  .cell{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);margin-bottom:.6rem;box-shadow:var(--shadow-sm);transition:border-color .2s,box-shadow .2s}
  .cell:focus-within{border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(37,99,235,.07)}
  .cell.running{border-color:var(--warning)}
  .cell-head{display:flex;align-items:center;padding:.3rem .7rem;border-bottom:1px solid var(--border);background:#fafaf7;border-radius:var(--radius) var(--radius) 0 0;gap:.45rem;min-height:30px}
  .cell-idx{font-family:var(--mono);font-size:.66rem;color:var(--text-muted);min-width:44px}
  .cell-badge{font-family:var(--mono);font-size:.6rem;padding:1px 7px;border-radius:4px;color:#fff;letter-spacing:.3px;text-transform:uppercase;cursor:pointer;transition:opacity .15s}
  .cell-badge:hover{opacity:.8}
  .cell-badge.math{background:#7c3aed}.cell-badge.text{background:#d97706}.cell-badge.raw{background:#64748b}
  .mode-toggle{font-family:var(--mono);font-size:.63rem;display:flex;border:1px solid var(--border);border-radius:4px;overflow:hidden;margin-inline-start:.2rem}
  .mode-toggle button{padding:2px 7px;border:none;background:transparent;color:var(--text-muted);cursor:pointer;font-family:inherit;font-size:inherit;transition:all .15s}
  .mode-toggle button.active{background:var(--accent);color:#fff}
  .mode-toggle button:hover:not(.active){background:var(--accent-light)}
  .cell-actions{margin-inline-start:auto;display:flex;gap:3px;opacity:0;transition:opacity .15s}
  .cell:hover .cell-actions{opacity:1}
  .cell-actions button{font-size:.66rem;padding:2px 7px;border:none;border-radius:3px;background:transparent;color:var(--text-muted);cursor:pointer;font-family:var(--mono)}
  .cell-actions button:hover{background:#eee;color:var(--text)}
  .cell-actions button.del:hover{background:#fee;color:var(--error)}

  /* ═══════ Insert Cell Zones ═══════ */
  .cell-insert-zone{display:flex;justify-content:flex-start;align-items:center;height:12px;cursor:pointer;margin:-6px 0;position:relative;z-index:2;padding-inline-start:5%}
  .cell-insert-zone span{opacity:.35;font-size:.75rem;font-family:var(--mono);color:var(--text-muted);background:var(--surface);border:1px solid var(--border);border-radius:50%;width:22px;height:22px;line-height:20px;text-align:center;box-shadow:var(--shadow-sm);transition:opacity .15s}
  .cell-insert-zone:hover span{opacity:1}
  .cell-insert-zone:hover span:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* ═══════ Input ═══════ */
  .cell-input{padding:.65rem .8rem;min-height:46px}
  .cell-input math-field{width:100%;font-size:1.2rem;border:none;outline:none;--caret-color:var(--accent);--selection-background-color:rgba(37,99,235,.12)}
  .cell-input textarea{width:100%;min-height:34px;border:none;outline:none;font-family:var(--mono);font-size:.8rem;color:var(--text);background:transparent;resize:vertical;line-height:1.55}

  /* ═══════ Debug ═══════ */
  .cell-debug{padding:.3rem .8rem;background:#f7f6f2;border-top:1px dashed var(--border);font-family:var(--mono);font-size:.65rem;color:var(--text-muted);display:none;overflow-x:auto;word-break:break-all}
  .cell-debug.visible{display:block}
  .cell-debug .lbl{font-weight:500;color:var(--accent);margin-inline-end:.3rem}
  .cell-debug .xcas-out{color:var(--success);margin-inline-start:.4rem}

  /* ═══════ Output ═══════ */
  .cell-output{padding:.65rem .8rem;background:var(--output-bg);border-top:1px solid var(--border);border-radius:0 0 var(--radius) var(--radius);min-height:26px;overflow-x:auto}
  .cell-output:empty{display:none}
  .cell-output .err{color:var(--error);font-family:var(--mono);font-size:.78rem}
  .cell-output .katex-display{margin:.2rem 0;text-align:start}
  .cell-output .raw-res{font-family:var(--mono);font-size:.72rem;color:var(--text-muted);margin-top:.3rem;white-space:pre-wrap}
  .cell-output .md-out{font-family:var(--body);font-size:.93rem}
  .cell-output .md-out h1{font-size:1.35rem;margin:.35rem 0}
  .cell-output .md-out h2{font-size:1.1rem;margin:.3rem 0}
  .cell-output .md-out h3{font-size:.95rem;margin:.25rem 0}
  .cell-output .md-out p{margin:.3rem 0}
  .cell-output .md-out code{background:#eee;padding:1px 5px;border-radius:3px;font-family:var(--mono);font-size:.83em}
  .spinner{display:inline-block;width:12px;height:12px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .5s linear infinite;vertical-align:middle;margin-inline-end:5px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ═══════ Plot ═══════ */
  .plot-container{margin:.3rem 0;position:relative}
  .plot-container canvas{max-width:100%;height:auto;display:block;border:1px solid var(--border);border-radius:4px}
  .plot-svg{overflow:hidden}
  .plot-svg svg{max-width:100%;height:auto;display:block}
  .plot-tooltip{position:absolute;background:rgba(0,0,0,.8);color:#fff;font-family:var(--mono);font-size:.65rem;padding:2px 6px;border-radius:3px;pointer-events:none;white-space:nowrap;z-index:5;display:none}
  .plot-3d-msg{font-family:var(--mono);font-size:.78rem;color:var(--warning);padding:.4rem;background:#fffbeb;border:1px solid #fde68a;border-radius:4px}
  .jxgbox-container{margin:.3rem 0}
  .jxgbox-container .jxgbox{width:100%;aspect-ratio:4/3;max-width:600px;border-radius:4px}
  .jsxgraph-3d-container{margin:.3rem 0}
  .jsxgraph-3d-container .jxgbox{width:100%;aspect-ratio:1/1;max-width:500px;border-radius:4px}
  .gl3d-container{margin:.3rem 0;position:relative}
  .gl3d-container canvas{max-width:100%;height:auto;display:block;border:1px solid var(--border);border-radius:4px;cursor:grab}
  .gl3d-container canvas:active{cursor:grabbing}

  /* ═══════ Cell Controls (hide, disable, lock) ═══════ */
  .cell-hidden > .cell-input,
  .cell-hidden > .cell-debug{display:none}
  .cell-hidden-placeholder{padding:.25rem .8rem;background:#f7f6f2;border-bottom:1px solid var(--border);cursor:pointer;display:flex;align-items:center;gap:.4rem;min-height:8px}
  .cell-hidden-placeholder:hover{background:var(--accent-light)}
  .cell-hidden-placeholder span{font-family:var(--mono);font-size:.6rem;color:var(--text-muted)}
  .cell-disabled{opacity:.45}
  .cell-disabled .cell-badge{text-decoration:line-through}
  .cell-disabled .cell-input{pointer-events:none}
  .cell-locked .cell-input{position:relative}
  .cell-locked .cell-input::after{content:'';position:absolute;inset:0;cursor:not-allowed}
  .cell-lock-indicator{font-family:var(--mono);font-size:.58rem;color:var(--text-muted);margin-inline-start:.3rem}
  .cell-controls{display:flex;gap:2px;margin-inline-end:.3rem}
  .cell-controls button{font-size:.6rem;padding:1px 5px;border:none;border-radius:3px;background:transparent;color:var(--text-muted);cursor:pointer;font-family:var(--mono);line-height:1.4}
  .cell-controls button:hover{background:#eee;color:var(--text)}
  .cell-controls button.active{color:var(--accent);font-weight:600}
  .report-view .cell-input,
  .report-view .cell-debug{display:none}
  .report-view .cell-hidden-placeholder{display:none}

  /* ═══════ Drag-and-Drop ═══════ */
  .drag-handle{cursor:grab;color:var(--text-muted);font-size:.85rem;user-select:none;padding:0 .1rem;line-height:1}
  .drag-handle:active{cursor:grabbing}
  .cell-dragging{opacity:.45;border-style:dashed}
  .cell-drag-over-top{border-top:2.5px solid var(--accent) !important}
  .cell-drag-over-bottom{border-bottom:2.5px solid var(--accent) !important}

  /* ═══════ Reactive DAG ═══════ */
  .cell.dep-upstream{border-color:#7c3aed;box-shadow:0 0 0 2px rgba(124,58,237,.15)}
  .cell.dep-downstream{border-color:#059669;box-shadow:0 0 0 2px rgba(5,150,105,.15)}
  .cell.cell-pending{border-color:var(--warning);opacity:.7}
  .cell.cell-pending::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--warning),transparent);animation:pendingPulse 1.5s ease-in-out infinite}
  @keyframes pendingPulse{0%,100%{opacity:.3}50%{opacity:1}}
  .cell.cell-stale{border-color:var(--warning);border-style:dashed}
  .cell.cell-error .cell-output{border-inline-start:3px solid var(--error)}
  .reactive-toggle{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:.72rem;cursor:pointer}
  .reactive-toggle input[type="checkbox"]{accent-color:var(--success);cursor:pointer}
  .reactive-toggle .reactive-label{color:var(--text-muted);transition:color .2s}
  .reactive-toggle input:checked+.reactive-label{color:var(--success);font-weight:500}
  .dep-warning{font-family:var(--mono);font-size:.72rem;padding:.3rem .5rem;border-radius:4px;margin:.2rem 0}
  .dep-warning.cycle{background:#fef2f2;color:var(--error);border:1px solid #fecaca}
  .dep-warning.broken{background:#fffbeb;color:var(--warning);border:1px solid #fde68a}
  .dep-warning.duplicate{background:#eff6ff;color:var(--accent);border:1px solid #bfdbfe}
  .stale-banner{background:#fffbeb;border:1px solid #fde68a;border-radius:6px;padding:.5rem 1rem;margin:.5rem 0;display:flex;align-items:center;gap:.5rem;font-family:var(--mono);font-size:.75rem;color:var(--warning)}
  .stale-banner button{font-family:var(--mono);font-size:.7rem;padding:3px 10px;border:1px solid var(--warning);border-radius:4px;background:transparent;color:var(--warning);cursor:pointer}
  .stale-banner button:hover{background:var(--warning);color:#fff}

  /* ═══════ Virtual keyboard — icons on the left ═══════ */
  math-field::part(container){flex-direction:row-reverse}

  /* ═══════ Bottom bar ═══════ */
  .bottombar{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);padding:.4rem 1.5rem;font-family:var(--mono);font-size:.63rem;color:var(--text-muted);display:flex;gap:1.4rem;align-items:center;z-index:10}
  .bottombar kbd{background:#eeede8;padding:1px 5px;border-radius:3px;border:1px solid var(--border);font-size:.62rem}
  .bottombar label{display:flex;align-items:center;gap:4px;cursor:pointer}
  .bottombar input[type="checkbox"]{accent-color:var(--accent)}
